å¥½çš„ï¼Œè¿™æ˜¯ä½ åŸºäº Socket ç¼–å†™çš„ Java èŠå¤©ç¨‹åºä¸­**æœåŠ¡ç«¯éƒ¨åˆ†çš„å®Œæ•´å¼€å‘æµç¨‹æ—¥å¿—**ï¼ŒæŒ‰ç…§é¡¹ç›®å¼€å‘é¡ºåºæ¢³ç†ï¼Œä¾¿äºå°†æ¥å›é¡¾ã€å¤ç°æˆ–å‚è€ƒã€‚

---

# ğŸ§¾ Java Socket èŠå¤©ç¨‹åºæœåŠ¡ç«¯å¼€å‘æ—¥å¿—

---

## ğŸ“Œ é¡¹ç›®ç›®æ ‡

å¼€å‘ä¸€ä¸ªåŸºäº TCP Socket çš„å¤šç”¨æˆ·èŠå¤©æœåŠ¡å™¨ï¼Œå®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

* æ”¯æŒç”¨æˆ·æ³¨å†Œã€ç™»å½•ï¼ˆç”¨æˆ·åå”¯ä¸€ï¼‰
* åœ¨çº¿ç”¨æˆ·åˆ—è¡¨åŒæ­¥
* ç¾¤èŠï¼ˆå¹¿æ’­æ¶ˆæ¯ï¼‰
* ç§èŠï¼ˆé€šè¿‡åè®® @ç”¨æˆ·å å®ç°ï¼‰
* ç”¨æˆ·ä¸Šä¸‹çº¿é€šçŸ¥
* ç”¨æˆ·æ³¨å†Œä¿¡æ¯æœ¬åœ°æŒä¹…åŒ–ï¼ˆusers.txtï¼‰

---

## ğŸ—‚ï¸ é¡¹ç›®ç»“æ„ï¼ˆæœåŠ¡ç«¯ï¼‰

```
src/
â””â”€â”€ server/
    â”œâ”€â”€ ChatServer.java         // ä¸»æœåŠ¡å™¨ç±»ï¼Œç›‘å¬ç«¯å£ï¼Œæ¥æ”¶è¿æ¥
    â”œâ”€â”€ ClientHandler.java      // å®¢æˆ·ç«¯å¤„ç†çº¿ç¨‹ï¼Œå¤„ç†ç™»å½•ã€æ¶ˆæ¯ã€æ³¨å†Œç­‰
    â””â”€â”€ users.txt               // æ³¨å†Œç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨æˆ·å:å¯†ç ï¼‰
```

---

## ğŸ§± å¼€å‘æ­¥éª¤æ—¥å¿—

---

### ç¬¬ 1 æ­¥ï¼šæ­å»ºåŸºæœ¬ Socket æœåŠ¡ç«¯ç»“æ„

æ–‡ä»¶ï¼š`ChatServer.java`

* åˆ›å»ºä¸€ä¸ª `ServerSocket` ç›‘å¬ç«¯å£ï¼ˆå¦‚ 12345ï¼‰
* æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¿æ¥åï¼Œä¸ºå…¶åˆ›å»ºä¸€ä¸ª `ClientHandler` çº¿ç¨‹å¤„ç†é€šä¿¡
* ä½¿ç”¨ `ConcurrentHashMap<String, ClientHandler>` ç®¡ç†æ‰€æœ‰åœ¨çº¿ç”¨æˆ·ï¼ˆç”¨æˆ·åä½œä¸º keyï¼‰

```java
while (true) {
    Socket clientSocket = serverSocket.accept();
    new Thread(new ClientHandler(clientSocket, clients)).start();
}
```

---

### ç¬¬ 2 æ­¥ï¼šå®ç° ClientHandler åŸºç¡€é€šä¿¡å¤„ç†é€»è¾‘

æ–‡ä»¶ï¼š`ClientHandler.java`

* ä¸ºæ¯ä¸ªè¿æ¥çš„å®¢æˆ·ç«¯ï¼š

  * å»ºç«‹è¾“å…¥è¾“å‡ºæµ
  * è¯»å–ç¬¬ä¸€è¡Œåˆ¤æ–­æ˜¯å¦ä¸ºæ³¨å†Œæˆ–ç™»å½•è¯·æ±‚
  * éªŒè¯ç™»å½•ä¿¡æ¯æˆ–å¤„ç†æ³¨å†Œï¼Œåé¦ˆ SUCCESS/å¤±è´¥åŸå› 

---

### ç¬¬ 3 æ­¥ï¼šå®ç°ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½

* å®¢æˆ·ç«¯é€šè¿‡ `"REGISTER:ç”¨æˆ·å:å¯†ç "` å‘é€è¯·æ±‚
* æœåŠ¡ç«¯è§£æåï¼š

  * æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨ï¼ˆæŸ¥å†…å­˜ mapï¼‰
  * å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä¿å­˜åˆ°å†…å­˜ mapï¼Œå¹¶è¿½åŠ å†™å…¥ `users.txt`
  * å¦åˆ™è¿”å›â€œç”¨æˆ·åå·²å­˜åœ¨â€

```java
private void handleRegister(String line) {
    // line æ ¼å¼: REGISTER:username:password
    ...
    saveUserToFile(username, password);
}
```

---

### ç¬¬ 4 æ­¥ï¼šå®ç°ç”¨æˆ·ç™»å½•éªŒè¯åŠŸèƒ½

* å®¢æˆ·ç«¯é€šè¿‡ `"LOGIN:ç”¨æˆ·å:å¯†ç "` è¯·æ±‚ç™»å½•
* æœåŠ¡ç«¯æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç”¨æˆ·ï¼Œå¯†ç æ˜¯å¦æ­£ç¡®ï¼Œæ˜¯å¦å·²ç»åœ¨çº¿

```java
if (!userDatabase.containsKey(username)) // æœªæ³¨å†Œ
if (!userDatabase.get(username).equals(password)) // å¯†ç é”™è¯¯
if (clients.containsKey(username)) // é‡å¤ç™»å½•
```

ç™»å½•æˆåŠŸåï¼Œå°†è¯¥ `ClientHandler` å®ä¾‹æ·»åŠ åˆ° `clients` åœ¨çº¿åˆ—è¡¨ä¸­ã€‚

---

### ç¬¬ 5 æ­¥ï¼šå¹¿æ’­ä¸Šçº¿é€šçŸ¥ + åŒæ­¥åœ¨çº¿ç”¨æˆ·åˆ—è¡¨

```java
broadcast("[ç³»ç»Ÿ] " + username + " å·²ä¸Šçº¿");
updateUserList();
```

* æ‰€æœ‰åœ¨çº¿ç”¨æˆ·é€šè¿‡åè®® `[USERLIST]user1,user2,...` åŒæ­¥æ˜¾ç¤ºåœ¨çº¿ç”¨æˆ·åˆ—è¡¨

---

### ç¬¬ 6 æ­¥ï¼šå®ç°ç¾¤èŠåŠŸèƒ½

* å®¢æˆ·ç«¯å‘é€ `[GROUP]æ¶ˆæ¯å†…å®¹`
* æœåŠ¡ç«¯æˆªå–åé€šè¿‡ `broadcast()` æ–¹æ³•ç¾¤å‘åˆ°æ‰€æœ‰åœ¨çº¿ç”¨æˆ·

```java
broadcast(username + ": " + msg);
```

---

### ç¬¬ 7 æ­¥ï¼šå®ç°ç§èŠåŠŸèƒ½

* å®¢æˆ·ç«¯å‘é€ `[PRIVATE]sender:receiver:message`
* æœåŠ¡ç«¯è§£æ senderã€receiverï¼Œæ‰¾åˆ°ç›®æ ‡ç”¨æˆ· `ClientHandler`
* å•ç‹¬å‘ç›®æ ‡å‘é€ `[ç§èŠ]sender:message`

```java
ClientHandler target = clients.get(receiver);
if (target != null) {
    target.writer.println("[ç§èŠ] " + sender + ": " + content);
}
```

---

### ç¬¬ 8 æ­¥ï¼šå¤„ç†ä¸‹çº¿å’Œå¼‚å¸¸è¿æ¥æ–­å¼€

* åœ¨çº¿ç¨‹ `finally` ä¸­ç§»é™¤è¯¥ç”¨æˆ·çš„åœ¨çº¿çŠ¶æ€
* å¹¿æ’­ç”¨æˆ·ä¸‹çº¿é€šçŸ¥
* åŒæ­¥ç”¨æˆ·åˆ—è¡¨

```java
clients.remove(username);
broadcast("[ç³»ç»Ÿ] " + username + " å·²ä¸‹çº¿");
updateUserList();
```

---

### ç¬¬ 9 æ­¥ï¼šç”¨æˆ·æ•°æ®æŒä¹…åŒ–

* æ³¨å†ŒæˆåŠŸåè¿½åŠ å†™å…¥ `users.txt` æ–‡ä»¶
* ç¨‹åºå¯åŠ¨æ—¶ï¼Œé€šè¿‡é™æ€ä»£ç å— `loadUserDatabase()` åŠ è½½å†å²æ³¨å†Œç”¨æˆ·

```java
static {
    loadUserDatabase(); // åˆæ¬¡åŠ è½½æ³¨å†Œæ•°æ®
}
```

---

## âœ… å·²å®Œæˆçš„åè®®è®¾è®¡

| åŠŸèƒ½   | å®¢æˆ·ç«¯å‘é€            | æœåŠ¡ç«¯å“åº”                      |
| ---- | ---------------- | -------------------------- |
| æ³¨å†Œ   | REGISTER:ç”¨æˆ·å:å¯†ç   | SUCCESS / ç”¨æˆ·åå·²å­˜åœ¨           |
| ç™»å½•   | LOGIN:ç”¨æˆ·å:å¯†ç      | SUCCESS / é”™è¯¯ä¿¡æ¯             |
| ç¾¤èŠ   | \[GROUP]æ¶ˆæ¯       | ç”¨æˆ·å: æ¶ˆæ¯                    |
| ç§èŠ   | \[PRIVATE]å‘:æ”¶:å†…å®¹ | \[ç§èŠ]å‘: å†…å®¹ æˆ– ç”¨æˆ·ä¸åœ¨çº¿æç¤º       |
| ç”¨æˆ·åˆ—è¡¨ | â€”â€”               | \[USERLIST]user1,user2,... |
| ä¸Šçº¿é€šçŸ¥ | â€”â€”               | \[ç³»ç»Ÿ] ç”¨æˆ·å å·²ä¸Šçº¿              |
| ä¸‹çº¿é€šçŸ¥ | â€”â€”               | \[ç³»ç»Ÿ] ç”¨æˆ·å å·²ä¸‹çº¿              |

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹ä¸åç»­ä¼˜åŒ–å»ºè®®

| é—®é¢˜/é™åˆ¶    | å½“å‰åšæ³•             | å»ºè®®æ”¹è¿›               |
| -------- | ---------------- | ------------------ |
| å¹¶å‘è¯»å†™ç”¨æˆ·æ•°æ® | åŒæ­¥å— synchronized | å°†æ¥å¯ç”¨æ•°æ®åº“æ›¿ä»£          |
| ç§èŠç”¨æˆ·ä¸åœ¨çº¿  | æ˜¾ç¤ºâ€œç”¨æˆ·ä¸åœ¨çº¿â€        | å¯æ·»åŠ ç¦»çº¿æ¶ˆæ¯ç¼“å­˜          |
| ç”¨æˆ·éªŒè¯å®‰å…¨æ€§  | æ˜æ–‡å¯†ç ï¼Œç®€å•æ–‡æœ¬å­˜å‚¨      | å¯ä½¿ç”¨å¯†ç åŠ å¯†ï¼ˆå¦‚ SHA-256ï¼‰ |
| æ¶ˆæ¯å¹¿æ’­æ•ˆç‡   | å¾ªç¯æ‰€æœ‰è¿æ¥           | å¯åŠ å…¥çº¿ç¨‹æ± ç®¡ç†ä¼˜åŒ–èµ„æº       |

---

## ğŸ é¡¹ç›®è¿è¡Œè¯´æ˜

* å¯åŠ¨ `ChatServer.java`ï¼Œç›‘å¬ 12345 ç«¯å£
* å®¢æˆ·ç«¯é€šè¿‡ TCP Socketï¼ˆæˆ– UIï¼‰è¿æ¥ï¼Œå‘é€ç™»å½•/æ³¨å†Œè¯·æ±‚
* æ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯å¹¶å‘è¿æ¥ã€æ¶ˆæ¯é€šä¿¡

---

å¦‚ä½ åç»­å‡†å¤‡æ‰“åŒ…é¡¹ç›®ï¼Œå¯ä»¥å°†ä»¥ä¸Šæ—¥å¿—ä¿å­˜ä¸º `docs/server-development-log.md`ï¼Œä½œä¸ºé¡¹ç›®æ–‡æ¡£ç•™å­˜ã€‚

å¦‚æœä½ éœ€è¦æˆ‘å¸®ä½ ç»§ç»­æ¢³ç† **å®¢æˆ·ç«¯å¼€å‘æµç¨‹æ—¥å¿—**ï¼Œæˆ–è€…æƒ³æ•´ç†æˆ PDFã€Word ç­‰æ–‡æ¡£æ ¼å¼ï¼Œä¹Ÿå¯ä»¥å‘Šè¯‰æˆ‘ã€‚
