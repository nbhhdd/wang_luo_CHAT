 ğŸ§¾ Java Socket èŠå¤©ç¨‹åºæœåŠ¡ç«¯å¼€å‘æ—¥å¿—

ğŸ“Œ é¡¹ç›®ç›®æ ‡

å¼€å‘ä¸€ä¸ªåŸºäº TCP Socket çš„å¤šç”¨æˆ·èŠå¤©æœåŠ¡å™¨ï¼Œå®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

* æ”¯æŒç”¨æˆ·æ³¨å†Œã€ç™»å½•ï¼ˆç”¨æˆ·åå”¯ä¸€ï¼‰
* åœ¨çº¿ç”¨æˆ·åˆ—è¡¨åŒæ­¥
* ç¾¤èŠï¼ˆå¹¿æ’­æ¶ˆæ¯ï¼‰
* ç§èŠï¼ˆé€šè¿‡åè®® @ç”¨æˆ·å å®ç°ï¼‰
* ç”¨æˆ·ä¸Šä¸‹çº¿é€šçŸ¥
* ç”¨æˆ·æ³¨å†Œä¿¡æ¯æœ¬åœ°æŒä¹…åŒ–ï¼ˆusers.txtï¼‰


 ğŸ—‚ï¸ é¡¹ç›®ç»“æ„ï¼ˆæœåŠ¡ç«¯ï¼‰
src/
â””â”€â”€ server/
    â”œâ”€â”€ ChatServer.java         // ä¸»æœåŠ¡å™¨ç±»ï¼Œç›‘å¬ç«¯å£ï¼Œæ¥æ”¶è¿æ¥
    â”œâ”€â”€ ClientHandler.java      // å®¢æˆ·ç«¯å¤„ç†çº¿ç¨‹ï¼Œå¤„ç†ç™»å½•ã€æ¶ˆæ¯ã€æ³¨å†Œç­‰
    â””â”€â”€ users.txt               // æ³¨å†Œç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨æˆ·å:å¯†ç ï¼‰
ğŸ§± å¼€å‘æ­¥éª¤æ—¥å¿—
ç¬¬ 1 æ­¥ï¼šæ­å»ºåŸºæœ¬ Socket æœåŠ¡ç«¯ç»“æ„

æ–‡ä»¶ï¼š`ChatServer.java`

* åˆ›å»ºä¸€ä¸ª `ServerSocket` ç›‘å¬ç«¯å£ï¼ˆå¦‚ 12345ï¼‰
* æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¿æ¥åï¼Œä¸ºå…¶åˆ›å»ºä¸€ä¸ª `ClientHandler` çº¿ç¨‹å¤„ç†é€šä¿¡
* ä½¿ç”¨ `ConcurrentHashMap<String, ClientHandler>` ç®¡ç†æ‰€æœ‰åœ¨çº¿ç”¨æˆ·ï¼ˆç”¨æˆ·åä½œä¸º keyï¼‰
java
   try (ServerSocket serverSocket = new ServerSocket(PORT)) {
            while (true) {
//                è°ƒç”¨ accept() æ–¹æ³•ï¼Œé˜»å¡ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ã€‚
//                ä¸€æ—¦æœ‰å®¢æˆ·ç«¯è¿æ¥æˆåŠŸï¼Œå°±ä¼šè¿”å›ä¸€ä¸ª Socket å¯¹è±¡ï¼Œè¡¨ç¤ºä¸è¯¥å®¢æˆ·ç«¯çš„é€šä¿¡é€šé“ã€‚
                Socket clientSocket = serverSocket.accept();
                System.out.println("æ–°è¿æ¥: " + clientSocket.getInetAddress());
//                ä¸ºæ¯ä¸ªæ–°è¿æ¥çš„å®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œå¹¶ä¼ å…¥ ClientHandler å¤„ç†å™¨ã€‚
//                ClientHandler æ˜¯ä¸€ä¸ªå®ç°äº† Runnable æ¥å£çš„ç±»ï¼Œè´Ÿè´£å¤„ç†è¯¥å®¢æˆ·ç«¯çš„æ‰€æœ‰æ¶ˆæ¯æ”¶å‘é€»è¾‘ã€‚
//                clients æ˜¯ä¸€ä¸ªå…±äº«çš„åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼ˆMapï¼‰ï¼Œç”¨äºå¹¿æ’­æ¶ˆæ¯æˆ–ç®¡ç†ç”¨æˆ·çŠ¶æ€ã€‚
                //ä¸ºæ–°ç”¨æˆ·åˆ›å»ºçº¿ç¨‹
                new Thread(new ClientHandler(clientSocket, clients)).start();
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
ç¬¬ 2 æ­¥ï¼šå®ç° ClientHandler åŸºç¡€é€šä¿¡å¤„ç†é€»è¾‘

æ–‡ä»¶ï¼š`ClientHandler.java`
å»ºç«‹åŸºæœ¬å±æ€§
    // å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨é€šä¿¡çš„Socketè¿æ¥
    private Socket socket;

    // è¾“å…¥æµï¼Œç”¨äºè¯»å–å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯
    private BufferedReader reader;

    // è¾“å‡ºæµï¼Œç”¨äºå‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
    private PrintWriter writer;

    // å½“å‰å®¢æˆ·ç«¯çš„ç”¨æˆ·åï¼ˆç™»å½•æˆåŠŸåèµ‹å€¼ï¼‰
    private String username;
    // ç”¨äºå­˜å‚¨æ‰€æœ‰åœ¨çº¿ç”¨æˆ·
    private Map<String, ClientHandler> clients;

    // æ”¹ä¸ºç»å¯¹è·¯å¾„ï¼Œç¡®ä¿æ‰“åŒ…è¿è¡Œæ—¶ä»èƒ½æ‰¾åˆ°æ–‡ä»¶
    // è®¾ç½®ç”¨æˆ·ä¿¡æ¯ä¿å­˜è·¯å¾„ä¸ºå½“å‰å·¥ä½œç›®å½•ä¸‹çš„ users.txt
    private static final String USER_FILE = System.getProperty("user.dir") + File.separator + "users.txt";

    // ç”¨äºå­˜å‚¨æ‰€æœ‰æ³¨å†Œè¿‡çš„ç”¨æˆ·å’Œå¯†ç ï¼ˆæ³¨å†Œæ—¶å†™å…¥ï¼Œç™»å½•æ—¶è¯»å–éªŒè¯ï¼‰
    private static Map<String, String> userDatabase = new ConcurrentHashMap<>();
//    ConcurrentHashMap æ˜¯çº¿ç¨‹å®‰å…¨çš„é›†åˆï¼Œç”¨äºå¤šçº¿ç¨‹ç¯å¢ƒã€‚
//    System.getProperty("user.dir") è¡¨ç¤ºç¨‹åºå¯åŠ¨æ—¶æ‰€åœ¨ç›®å½•

    // åŠ è½½ç”¨æˆ·æ•°æ®
    static {
        loadUserDatabase();
    }
* ä¸ºæ¯ä¸ªè¿æ¥çš„å®¢æˆ·ç«¯ï¼š

  * å»ºç«‹è¾“å…¥è¾“å‡ºæµ
  * è¯»å–ç¬¬ä¸€è¡Œåˆ¤æ–­æ˜¯å¦ä¸ºæ³¨å†Œæˆ–ç™»å½•è¯·æ±‚
  * éªŒè¯ç™»å½•ä¿¡æ¯æˆ–å¤„ç†æ³¨å†Œï¼Œåé¦ˆ SUCCESS/å¤±è´¥åŸå› 

ç¬¬ 3 æ­¥ï¼šå®ç°ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½

* å®¢æˆ·ç«¯é€šè¿‡ `"REGISTER:ç”¨æˆ·å:å¯†ç "` å‘é€è¯·æ±‚
* æœåŠ¡ç«¯è§£æåï¼š

  * æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨ï¼ˆæŸ¥å†…å­˜ mapï¼‰
  * å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä¿å­˜åˆ°å†…å­˜ mapï¼Œå¹¶è¿½åŠ å†™å…¥ `users.txt`
  * å¦åˆ™è¿”å›â€œç”¨æˆ·åå·²å­˜åœ¨â€
è°ƒç”¨handleRegister(line)

  private void handleRegister(String line) {
        String[] parts = line.split(":", 3);
        if (parts.length < 3) {
            writer.println("æ³¨å†Œæ ¼å¼é”™è¯¯");
            return;
        }

        String uname = parts[1];
        String pwd = parts[2];

        if (userDatabase.containsKey(uname)) {
            writer.println("ç”¨æˆ·åå·²å­˜åœ¨");
        } else {
            userDatabase.put(uname, pwd);
            saveUserToFile(uname, pwd);
            writer.println("SUCCESS");
            System.out.println("æ³¨å†ŒæˆåŠŸ: " + uname);
        }
    }
 ç¬¬ 4 æ­¥ï¼šå®ç°ç”¨æˆ·ç™»å½•éªŒè¯åŠŸèƒ½

* å®¢æˆ·ç«¯é€šè¿‡ `"LOGIN:ç”¨æˆ·å:å¯†ç "` è¯·æ±‚ç™»å½•
* æœåŠ¡ç«¯æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç”¨æˆ·ï¼Œå¯†ç æ˜¯å¦æ­£ç¡®ï¼Œæ˜¯å¦å·²ç»åœ¨çº¿
è°ƒç”¨handleLogin(line)
    private boolean handleLogin(String line) {
        String[] parts = line.split(":", 3);
        if (parts.length < 3) {
            writer.println("ç™»å½•æ ¼å¼é”™è¯¯");
            return false;
        }

        String uname = parts[1];
        String pwd = parts[2];

        if (!userDatabase.containsKey(uname)) {
            writer.println("ç”¨æˆ·æœªæ³¨å†Œ");
            return false;
        }

        if (!userDatabase.get(uname).equals(pwd)) {
            writer.println("å¯†ç é”™è¯¯");
            return false;
        }

        if (clients.containsKey(uname)) {
            writer.println("è¯¥ç”¨æˆ·å·²åœ¨çº¿");
            return false;
        }

        this.username = uname;
        //å­˜æ”¾ä¸Šçº¿çš„äºº
        ç™»å½•æˆåŠŸåï¼Œå°†è¯¥ `ClientHandler` å®ä¾‹æ·»åŠ åˆ° `clients` åœ¨çº¿åˆ—è¡¨ä¸­ã€‚
        clients.put(username, this);
        writer.println("SUCCESS");
        return true;
    }
  //å¤„ç†æ³¨å†Œ
            if (line.startsWith("REGISTER:")) {
                handleRegister(line);
                return;

                //ç™»å½•
            } else if (line.startsWith("LOGIN:")) {
                if (!handleLogin(line)) return; // ç™»å½•å¤±è´¥ç›´æ¥æ–­å¼€
            } else {
                writer.println("éæ³•è¯·æ±‚æ ¼å¼");
                return;
            }



 ç¬¬ 5 æ­¥ï¼šå¹¿æ’­ä¸Šçº¿é€šçŸ¥ + åŒæ­¥åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
 //æœåŠ¡å™¨å‘æ¯ä¸ªå®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
broadcast("[ç³»ç»Ÿ] " + username + " å·²ä¸Šçº¿");
    private void broadcast(String message) {
        for (ClientHandler client : clients.values()) {
//            éå†å…¨å±€å˜é‡ clients ä¸­çš„æ‰€æœ‰åœ¨çº¿ç”¨æˆ·ï¼ˆæ¯ä¸ªç”¨æˆ·å¯¹åº”ä¸€ä¸ª ClientHandler å®ä¾‹ï¼‰ã€‚
//            clients æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ ConcurrentHashMap<String, ClientHandler>ï¼Œé”®æ˜¯ç”¨æˆ·åï¼Œå€¼æ˜¯å¯¹åº”çš„å®¢æˆ·ç«¯å¤„ç†å™¨ã€‚
            //å±•ç¤ºåŒºåŸŸæ¶ˆæ¯
            client.writer.println(message);
//            è·å–æ¯ä¸ªå®¢æˆ·ç«¯çš„è¾“å‡ºæµï¼ˆPrintWriterï¼‰ï¼Œå¹¶å‘å…¶å‘é€æ¶ˆæ¯ã€‚
//            æ¯ä¸ªå®¢æˆ·ç«¯æ”¶åˆ°è¯¥æ¶ˆæ¯åä¼šåœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºå‡ºæ¥ã€‚
        }
    }
    åŒæ­¥ç”¨æˆ·åœ¨çº¿åˆ—è¡¨
updateUserList();
    private void updateUserList() {
//        åˆ›å»ºä¸€ä¸ª StringBuilder å®ä¾‹ï¼Œç”¨äºé«˜æ•ˆæ‹¼æ¥å­—ç¬¦ä¸²ã€‚
        StringBuilder sb = new StringBuilder();
//        éå†å…¨å±€å˜é‡ clients çš„é”®é›†åˆï¼ˆå³æ‰€æœ‰åœ¨çº¿ç”¨æˆ·åï¼‰ã€‚
//        å°†æ¯ä¸ªç”¨æˆ·åè¿½åŠ åˆ° StringBuilder åé¢ï¼Œå¹¶åŠ ä¸Šé€—å· , åˆ†éš”ç¬¦ã€‚
//        ç¤ºä¾‹è¾“å‡ºï¼šAlice,Bob,Charlie,
        for (String user : clients.keySet()) {
            sb.append(user).append(",");
        }
        if (!sb.isEmpty()) sb.setLength(sb.length() - 1);
//        å¦‚æœ StringBuilder ä¸ä¸ºç©ºï¼Œåˆ™åˆ é™¤æœ€åä¸€ä¸ªå¤šä½™çš„é€—å·ã€‚
//        ç¤ºä¾‹å˜æˆï¼šAlice,Bob,Charlie

//        éå†æ‰€æœ‰åœ¨çº¿å®¢æˆ·ç«¯çš„å¤„ç†å¯¹è±¡ ClientHandlerã€‚
//        é€šè¿‡æ¯ä¸ªå®¢æˆ·ç«¯çš„è¾“å‡ºæµ PrintWriter å‘é€æ ¼å¼ä¸º [USERLIST]Alice,Bob,Charlie çš„æ¶ˆæ¯ã€‚
//        å®¢æˆ·ç«¯æ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯åä¼šè§£æå¹¶æ›´æ–°ç•Œé¢ä¸Šçš„åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ã€‚
        for (ClientHandler client : clients.values()) {
            client.writer.println("[USERLIST]" + sb);
        }
    }
* æ‰€æœ‰åœ¨çº¿ç”¨æˆ·é€šè¿‡åè®® `[USERLIST]user1,user2,...` åŒæ­¥æ˜¾ç¤ºåœ¨çº¿ç”¨æˆ·åˆ—è¡¨
### ç¬¬ 6 æ­¥ï¼šå®ç°ç¾¤èŠåŠŸèƒ½
* å®¢æˆ·ç«¯å‘é€ `[GROUP]æ¶ˆæ¯å†…å®¹`
* æœåŠ¡ç«¯æˆªå–åé€šè¿‡ `broadcast()` æ–¹æ³•ç¾¤å‘åˆ°æ‰€æœ‰åœ¨çº¿ç”¨æˆ·
broadcast(username + ": " + msg);

### ç¬¬ 7 æ­¥ï¼šå®ç°ç§èŠåŠŸèƒ½

* å®¢æˆ·ç«¯å‘é€ `[PRIVATE]sender:receiver:message`
* æœåŠ¡ç«¯è§£æ senderã€receiverï¼Œæ‰¾åˆ°ç›®æ ‡ç”¨æˆ· `ClientHandler`
* å•ç‹¬å‘ç›®æ ‡å‘é€ `[ç§èŠ]sender:message`

 private void handlePrivateMessage(String body) {
        String[] parts = body.split(":", 3);
        if (parts.length < 3) return;

        String sender = parts[0];
        String receiver = parts[1];
        String content = parts[2];
        //æ‰¾åˆ°ç›®æ ‡ç”¨æˆ·
        ClientHandler target = clients.get(receiver);
        if (target != null) {
            target.writer.println("[ç§èŠ] " + sender + ": " + content);
        } else {
            writer.println("[ç³»ç»Ÿ] ç”¨æˆ· " + receiver + " ä¸åœ¨çº¿ã€‚");
        }
    }

### ç¬¬ 8 æ­¥ï¼šå¤„ç†ä¸‹çº¿å’Œå¼‚å¸¸è¿æ¥æ–­å¼€

* åœ¨çº¿ç¨‹ `finally` ä¸­ç§»é™¤è¯¥ç”¨æˆ·çš„åœ¨çº¿çŠ¶æ€
* å¹¿æ’­ç”¨æˆ·ä¸‹çº¿é€šçŸ¥
* åŒæ­¥ç”¨æˆ·åˆ—è¡¨

finally {
            if (username != null) {
                //ä¸‹çº¿
                clients.remove(username);
                //å‘æ¯ä¸ªå®¢æˆ·ç«¯æ‰“å°
                broadcast("[ç³»ç»Ÿ] " + username + " å·²ä¸‹çº¿");
                //æ›´æ–° ç”¨æˆ·åˆ—è¡¨
                updateUserList();
            }

ç¬¬ 9 æ­¥ï¼šç”¨æˆ·æ•°æ®æŒä¹…åŒ–

* æ³¨å†ŒæˆåŠŸåè¿½åŠ å†™å…¥ `users.txt` æ–‡ä»¶
* ç¨‹åºå¯åŠ¨æ—¶ï¼Œé€šè¿‡é™æ€ä»£ç å— `loadUserDatabase()` åŠ è½½å†å²æ³¨å†Œç”¨æˆ·

java
static {
    loadUserDatabase(); // åˆæ¬¡åŠ è½½æ³¨å†Œæ•°æ®
}


## âœ… å·²å®Œæˆçš„åè®®è®¾è®¡

| åŠŸèƒ½   | å®¢æˆ·ç«¯å‘é€            | æœåŠ¡ç«¯å“åº”                      |
| ---- | ---------------- | -------------------------- |
| æ³¨å†Œ   | REGISTER:ç”¨æˆ·å:å¯†ç   | SUCCESS / ç”¨æˆ·åå·²å­˜åœ¨           |
| ç™»å½•   | LOGIN:ç”¨æˆ·å:å¯†ç      | SUCCESS / é”™è¯¯ä¿¡æ¯             |
| ç¾¤èŠ   | \[GROUP]æ¶ˆæ¯       | ç”¨æˆ·å: æ¶ˆæ¯                    |
| ç§èŠ   | \[PRIVATE]å‘:æ”¶:å†…å®¹ | \[ç§èŠ]å‘: å†…å®¹ æˆ– ç”¨æˆ·ä¸åœ¨çº¿æç¤º       |
| ç”¨æˆ·åˆ—è¡¨ | â€”â€”               | \[USERLIST]user1,user2,... |
| ä¸Šçº¿é€šçŸ¥ | â€”â€”               | \[ç³»ç»Ÿ] ç”¨æˆ·å å·²ä¸Šçº¿              |
| ä¸‹çº¿é€šçŸ¥ | â€”â€”               | \[ç³»ç»Ÿ] ç”¨æˆ·å å·²ä¸‹çº¿              |

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹ä¸åç»­ä¼˜åŒ–å»ºè®®

| é—®é¢˜/é™åˆ¶    | å½“å‰åšæ³•             | å»ºè®®æ”¹è¿›               |
| -------- | ---------------- | ------------------ |
| å¹¶å‘è¯»å†™ç”¨æˆ·æ•°æ® | åŒæ­¥å— synchronized | å°†æ¥å¯ç”¨æ•°æ®åº“æ›¿ä»£          |
| ç§èŠç”¨æˆ·ä¸åœ¨çº¿  | æ˜¾ç¤ºâ€œç”¨æˆ·ä¸åœ¨çº¿â€        | å¯æ·»åŠ ç¦»çº¿æ¶ˆæ¯ç¼“å­˜          |
| ç”¨æˆ·éªŒè¯å®‰å…¨æ€§  | æ˜æ–‡å¯†ç ï¼Œç®€å•æ–‡æœ¬å­˜å‚¨      | å¯ä½¿ç”¨å¯†ç åŠ å¯†ï¼ˆå¦‚ SHA-256ï¼‰ |
| æ¶ˆæ¯å¹¿æ’­æ•ˆç‡   | å¾ªç¯æ‰€æœ‰è¿æ¥           | å¯åŠ å…¥çº¿ç¨‹æ± ç®¡ç†ä¼˜åŒ–èµ„æº       |

---

## ğŸ é¡¹ç›®è¿è¡Œè¯´æ˜

* å¯åŠ¨ `ChatServer.java`ï¼Œç›‘å¬ 12345 ç«¯å£
* å®¢æˆ·ç«¯é€šè¿‡ TCP Socketï¼ˆæˆ– UIï¼‰è¿æ¥ï¼Œå‘é€ç™»å½•/æ³¨å†Œè¯·æ±‚
* æ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯å¹¶å‘è¿æ¥ã€æ¶ˆæ¯é€šä¿¡

å¦‚ä½ åç»­å‡†å¤‡æ‰“åŒ…é¡¹ç›®ï¼Œå¯ä»¥å°†ä»¥ä¸Šæ—¥å¿—ä¿å­˜ä¸º `docs/server-development-log.md`ï¼Œä½œä¸ºé¡¹ç›®æ–‡æ¡£ç•™å­˜ã€‚
